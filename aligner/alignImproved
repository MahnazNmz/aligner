#!/usr/bin/env python
import optparse
import sys
from collections import defaultdict

optparser = optparse.OptionParser()
optparser.add_option("-d", "--data", dest="train", default="data/hansards", help="Data filename prefix (default=data)")
optparser.add_option("-e", "--english", dest="english", default="e", help="Suffix of English filename (default=e)")
optparser.add_option("-f", "--french", dest="french", default="f", help="Suffix of French filename (default=f)")
optparser.add_option("-t", "--threshold", dest="threshold", default=0.5, type="float", help="Threshold for aligning with Dice's coefficient (default=0.5)")
optparser.add_option("-n", "--num_sentences", dest="num_sents", default=sys.maxint, type="int", help="Number of sentences to use for training and alignment")
(opts, _) = optparser.parse_args()
f_data = "%s.%s" % (opts.train, opts.french)
e_data = "%s.%s" % (opts.train, opts.english)

sys.stderr.write("Training with IBM Model 1...\n")
bitext = [[sentence.strip().split() for sentence in pair] for pair in zip(open(e_data),open(f_data))[:opts.num_sents]]

allEngWords = []
allForWords = []

for (es, fs) in bitext:
  allEngWords += es
  allForWords += fs

allEngWords = set(allEngWords)
allForWords = set(allForWords)

#initialize t(e|f) uniformly
t_e_f = defaultdict(float)
for ew in allEngWords:
  for fw in allForWords:
    t_e_f[(ew, fw)] = 1.0/len(allEngWords)

for i in range(5):
  
  #initialize
  count_e_f = defaultdict(float)
  total_f = defaultdict(float)

  for fw in allForWords:
    for ew in allEngWords:
      count_e_f[(ew,fw)] = 0
    total_f[fw] = 0

  s_total = defaultdict(float)
  for (es,fs) in bitext:
    #compute normalization
    for ew in es:
      s_total[ew] = 0
      for fw in fs:
        s_total[ew] += t_e_f[(ew, fw)]
    #collect counts
    for ew in es:
      for fw in fs:
        count_e_f[(ew,fw)] += t_e_f[(ew,fw)]/s_total[ew]
        total_f[fw] += t_e_f[(ew,fw)]/s_total[ew]

  #estimate probabilities
  for fw in allForWords:
    for ew in allEngWords:
      t_e_f[(ew, fw)] = count_e_f[(ew,fw)]/total_f[fw]



for (es, fs) in bitext:
  for (i, fw) in enumerate(fs):
    max_prob = -float('inf')
    translation = 0
    for (j, ew) in enumerate(es):
      if t_e_f[(ew, fw)] >= max_prob:
        max_prob = t_e_f[(ew,fw)]
        translation = j
    sys.stdout.write("%i-%i " % (i,translation)) 
  sys.stdout.write("\n")
